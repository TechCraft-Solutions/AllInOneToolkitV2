@if (windowInnerWidth <= 768 && isShowSidebar) {
  <div
    class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"
    (click)="isShowSidebar = false"
  ></div>
}

<div class="flex h-screen relative">
  <div
    class="bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-lg transition-transform duration-300 ease-in-out z-30
          md:relative md:translate-x-0
          {{
      windowInnerWidth <= 768
        ? isShowSidebar
          ? 'absolute left-0 top-0 h-full w-80'
          : '-translate-x-full absolute'
        : isShowSidebar
          ? 'w-80'
          : 'w-16'
    }}"
  >
    <div class="flex flex-col h-full">
      <div
        class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900"
      >
        @if (isShowSidebar) {
          <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Collections</h2>
        }
        <div class="flex flex-row gap-x-1">
          @if (isShowSidebar) {
            <button
              class="p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              (click)="createCollection()"
              matTooltip="Create new collection"
            >
              <mat-icon
                fontIcon="add"
                class="!w-6 !h-6 !text-2xl text-gray-600 dark:text-gray-300"
              />
            </button>
          }
          @if (windowInnerWidth <= 768) {
            <button
              class="ml-2 p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              (click)="isShowSidebar = false"
            >
              <mat-icon
                fontIcon="close"
                class="!w-6 !h-6 !text-2xl text-gray-600 dark:text-gray-300"
              />
            </button>
          } @else if (isShowSidebar) {
            <button
              class="ml-2 p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              (click)="isShowSidebar = false"
            >
              <mat-icon
                fontIcon="chevron_left"
                class="!w-6 !h-6 !text-2xl text-gray-600 dark:text-gray-300"
              />
            </button>
          } @else {
            <button
              class="p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              (click)="isShowSidebar = true"
            >
              <mat-icon
                fontIcon="chevron_right"
                class="!w-6 !h-6 !text-2xl text-gray-600 dark:text-gray-300"
              />
            </button>
          }
        </div>
      </div>

      @if (isShowSidebar) {
        <div class="flex-1 overflow-y-auto p-2">
          <div
            class="flex flex-col gap-y-2"
            cdkDropList
            cdkDropListGroup="requests"
            (cdkDropListDropped)="dropCollections($event)"
          >
            @for (coll of listCollections; track coll; let i = $index) {
              <mat-accordion
                class="bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm"
                cdkDrag
                cdkDragHandle
                cdkDropList
                cdkDropListGroup="requests"
                (cdkDropListDropped)="handleCollectionDrop($event, coll)"
              >
                <mat-expansion-panel
                  class="rounded-lg bg-transparent shadow-none"
                  [expanded]="coll.expanded"
                >
                  <mat-expansion-panel-header class="px-3 py-2 min-h-0">
                    <div class="flex items-center justify-between w-full group">
                      @if (coll.editTitle) {
                        <input
                          class="flex-1 bg-transparent styleBorderSolidLite !border-blue-500 outline-none text-gray-900 dark:text-white !w-1 !h-8"
                          type="text"
                          (click)="$event.stopPropagation()"
                          (keydown)="$event.stopPropagation()"
                          (keypress)="$event.stopPropagation()"
                          [(ngModel)]="prevTitleCollection"
                          (keyup)="setTitle($event, 'collection', coll)"
                          placeholder="Collection title"
                        />
                      } @else {
                        <span
                          class="text-sm font-medium text-gray-800 dark:text-gray-100 truncate"
                          [title]="coll.title"
                          >{{ coll.title }}</span
                        >
                      }
                      @if (coll.editTitle) {
                        <mat-icon
                          fontIcon="check"
                          class="!w-5 !h-7 !text-xl text-gray-600 dark:text-gray-300 hover:text-blue-200 dark:hover:text-blue-600"
                          (click)="$event.stopPropagation(); confirmRenameCollection($event, coll)"
                        />
                        <mat-icon
                          fontIcon="cancel"
                          class="!w-5 !h-7 !text-xl text-gray-600 dark:text-gray-300 hover:text-blue-200 dark:hover:text-blue-600"
                          (click)="$event.stopPropagation(); cancelRenameCollection($event, coll)"
                        />
                      } @else {
                        <div class="flex items-center gap-1 mr-2 opacity-0 group-hover:opacity-100">
                          <mat-icon
                            (click)="$event.stopPropagation(); renameCollection(coll)"
                            fontIcon="edit"
                            class="!w-5 !h-7 !text-xl text-gray-600 dark:text-gray-300 hover:text-blue-200 dark:hover:text-blue-600"
                          />
                          <mat-icon
                            (click)="$event.stopPropagation(); deleteCollection(i)"
                            fontIcon="delete"
                            class="!w-5 !h-7 !text-xl text-gray-600 dark:text-gray-300 hover:text-red-200 dark:hover:text-red-600"
                          />
                        </div>
                      }
                    </div>
                  </mat-expansion-panel-header>

                  <div class="px-2 pb-2">
                    <button
                      class="flex flex-row items-center justify-center gap-x-1 w-full mb-2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg !h-6 text-sm font-medium transition-colors"
                      (click)="$event.stopPropagation(); createRequest(coll)"
                    >
                      <mat-icon fontIcon="add" class="!w-5 !h-7 !text-xl" />
                      <span>Add Request</span>
                    </button>

                    <div
                      class="space-y-1"
                      cdkDropList
                      cdkDropListGroup="requests"
                      (cdkDropListDropped)="dropRequests($event, i)"
                    >
                      @for (req of coll.requests; track req; let j = $index) {
                        <div
                          class="flex items-center px-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer transition-colors group"
                          [class.bg-blue-100]="isDragging && hoveredRequestId === req.id"
                          [class.dark:bg-blue-900]="isDragging && hoveredRequestId === req.id"
                          (click)="$event.stopPropagation(); getInfo(coll, req)"
                          (mouseenter)="isDragging && onRequestHover(req)"
                          (mouseleave)="onRequestLeave(req)"
                          cdkDrag
                          cdkDragHandle
                        >
                          <div class="flex flex-1 flex-row items-center gap-2 min-w-0">
                            <span
                              class="w-16 text-base font-bold px-2 py-1 rounded-full {{
                                colorTypeRequest[req.typeReq]
                              }}"
                            >
                              {{ req.typeReq }}
                            </span>
                            <div class="flex flex-1 flex-col justify-start">
                              @if (req.editTitle) {
                                <input
                                  class="flex-1 bg-transparent styleBorderSolidLite !border-blue-500 outline-none text-sm text-gray-900 dark:text-white !w-32"
                                  type="text"
                                  (keydown)="$event.stopPropagation()"
                                  (keypress)="$event.stopPropagation()"
                                  [(ngModel)]="prevTitleRequest"
                                  (keyup)="setTitle($event, 'request', req)"
                                />
                              } @else {
                                <span
                                  class="text-sm truncate text-gray-700 dark:text-gray-300"
                                  [title]="req.title"
                                  >{{ req.title }}</span
                                >
                              }
                            </div>
                          </div>
                          @if (req.editTitle) {
                            <div class="flex flex-row gap-x-1">
                              <mat-icon
                                fontIcon="check"
                                class="!w-4 !h-5 !text-base text-gray-600 dark:text-gray-300 hover:text-blue-200 dark:hover:text-blue-600"
                                (click)="confirmRenameRequest($event, req)"
                              />
                              <mat-icon
                                fontIcon="cancel"
                                class="!w-4 !h-5 !text-base text-gray-600 dark:text-gray-300 hover:text-blue-200 dark:hover:text-blue-600"
                                (click)="cancelRenameRequest($event, req)"
                              />
                            </div>
                          } @else {
                            <div class="flex flex-row gap-x-1 opacity-0 group-hover:opacity-100">
                              <mat-icon
                                fontIcon="edit"
                                class="!w-4 !h-5 !text-base"
                                (click)="renameRequest(req)"
                              />
                              <mat-icon
                                fontIcon="delete"
                                class="!w-4 !h-5 !text-base"
                                (click)="deleteRequest(coll, j)"
                              />
                            </div>
                          }
                        </div>
                      }
                    </div>

                    @if (coll.requests.length === 0) {
                      <div class="text-center text-gray-500 dark:text-gray-400 py-4 text-sm">
                        No requests yet
                      </div>
                    }
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            }

            @if (listCollections.length === 0) {
              <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <mat-icon fontIcon="folder" class="!w-9 !h-10 text-4xl mb-2" />
                <p>No collections found</p>
                <p class="text-sm">Create your first collection to get started</p>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <div
    class="flex-1 flex flex-col overflow-hidden {{
      windowInnerWidth <= 768 ? 'ml-0' : isShowSidebar ? '' : 'ml-0'
    }}"
  >
    @if (windowInnerWidth <= 768) {
      <div
        class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center"
      >
        <button class="p-2 mr-2" (click)="isShowSidebar = true">
          <mat-icon fontIcon="menu" class="!w-5 !h-6 !text-2xl text-gray-600 dark:text-gray-300" />
        </button>
        <span class="font-medium">{{
          infoRequest ? infoCollection?.title + " / " + infoRequest.title : "API Requests"
        }}</span>
      </div>
    }

    <div class="flex-1 overflow-y-auto">
      @if (infoCollection && infoRequest) {
        <div class="p-4 space-y-6">
          <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4"
          >
            <div class="flex flex-col lg:flex-row items-start lg:items-center gap-3 mb-4 w-full">
              <mat-form-field class="w-full lg:w-32">
                <mat-select
                  class="!bg-transparent"
                  [(value)]="infoRequest.typeReq"
                  (valueChange)="infoRequest.typeReq = $event"
                >
                  @for (type of listTypesRequest; track type) {
                    <mat-option [ngClass]="type.color" [value]="type.title">{{
                      type.title
                    }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <div class="flex flex-col md:flex-row items-start md:items-center gap-3 w-full">
                <input
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none w-full"
                  type="text"
                  placeholder="Enter URL address"
                  [(ngModel)]="infoRequest.url"
                  (change)="parseUrl()"
                  (keyup)="setUrl($event)"
                />
                <div class="flex flex-1 flex-row justify-end gap-x-3 w-full">
                  <button
                    class="flex flex-row items-center gap-x-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-base transition-colors"
                    (click)="sendRequest()"
                  >
                    <mat-icon fontIcon="send" class="!w-4 !h-6 !text-base" />
                    Send
                  </button>
                  <button
                    class="flex flex-row items-center gap-x-1 px-4 py-2 rounded-lg bg-green-600 text-base text-white transition-colors"
                    (click)="saveData()"
                  >
                    <mat-icon fontIcon="save" class="!w-4 !h-6 !text-base" />
                    Save
                  </button>
                </div>
              </div>
            </div>

            @if (windowInnerWidth > 768) {
              <div
                class="flex flex-row items-center gap-2 text-sm text-gray-600 dark:text-gray-400"
              >
                <span>{{ infoCollection.title }}</span>
                <mat-icon fontIcon="chevron_right" class="!w-5 !h-7 !text-xl" />
                <span>{{ infoRequest.title }}</span>
              </div>
            }
          </div>

          @if (infoRequest) {
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
            >
              <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button
                  class="px-4 py-2 text-sm font-medium"
                  [class.bg-gray-200]="selectedTabIndex === 0"
                  [class.dark:bg-gray-600]="selectedTabIndex === 0"
                  (click)="selectedTabIndex = 0"
                  (mouseenter)="onTabHover('params')"
                >
                  Params
                </button>
                <button
                  class="px-4 py-2 text-sm font-medium"
                  [class.bg-gray-200]="selectedTabIndex === 1"
                  [class.dark:bg-gray-600]="selectedTabIndex === 1"
                  (click)="selectedTabIndex = 1"
                  (mouseenter)="onTabHover('headers')"
                >
                  Headers
                </button>
                <button
                  class="px-4 py-2 text-sm font-medium"
                  [class.bg-gray-200]="selectedTabIndex === 2"
                  [class.dark:bg-gray-600]="selectedTabIndex === 2"
                  (click)="selectedTabIndex = 2"
                  (mouseenter)="onTabHover('body')"
                >
                  Body
                </button>
                <button
                  class="px-4 py-2 text-sm font-medium"
                  [class.bg-gray-200]="selectedTabIndex === 3"
                  [class.dark:bg-gray-600]="selectedTabIndex === 3"
                  (click)="selectedTabIndex = 3"
                >
                  Response
                </button>
              </div>
              <div [hidden]="selectedTabIndex !== 0">
                <div class="flex justify-end mb-2">
                  <button
                    (click)="toggleEditorMode('params')"
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition-colors"
                  >
                    {{ typeEditorData.params === "table" ? "Raw" : "Table" }}
                  </button>
                </div>
                @if (typeEditorData.params === "table") {
                  <app-editable-table
                    [type]="'params'"
                    [list]="getList('params')"
                    [editingRow]="editingRow"
                    [editingCol]="editingCol"
                    [editingObj]="editingObj"
                    [infoRequest]="infoRequest"
                    [draggedItem]="draggedItem"
                    [isDragging]="isDragging"
                    [selectedTabIndex]="selectedTabIndex"
                    (editObj)="onTableEditObj($event)"
                    (selAll)="onTableSelAll($event)"
                    (onKeyDownEvent)="onTableKeyDown($event)"
                    (inputChangeEvent)="onTableInputChange($event)"
                    (deleteRec)="onTableDeleteRec($event)"
                    (onDragStartEvent)="onTableDragStart($event)"
                    (onDragEndEvent)="onTableDragEnd($event)"
                    (dropTableRecords)="onTableDropRecords($event)"
                  />
                } @else {
                  <textarea
                    class="w-full h-64 p-3 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    [value]="rawParams"
                    (input)="parseParam($event)"
                    placeholder="Enter parameters as JSON array..."
                  ></textarea>
                }
              </div>
              <div [hidden]="selectedTabIndex !== 1">
                <div class="flex justify-end mb-2">
                  <button
                    (click)="toggleEditorMode('headers')"
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition-colors"
                  >
                    {{ typeEditorData.headers === "table" ? "Raw" : "Table" }}
                  </button>
                </div>
                @if (typeEditorData.headers === "table") {
                  <app-editable-table
                    [type]="'headers'"
                    [list]="getList('headers')"
                    [editingRow]="editingRow"
                    [editingCol]="editingCol"
                    [editingObj]="editingObj"
                    [infoRequest]="infoRequest"
                    [draggedItem]="draggedItem"
                    [isDragging]="isDragging"
                    [selectedTabIndex]="selectedTabIndex"
                    (editObj)="onTableEditObj($event)"
                    (selAll)="onTableSelAll($event)"
                    (onKeyDownEvent)="onTableKeyDown($event)"
                    (inputChangeEvent)="onTableInputChange($event)"
                    (deleteRec)="onTableDeleteRec($event)"
                    (onDragStartEvent)="onTableDragStart($event)"
                    (onDragEndEvent)="onTableDragEnd($event)"
                    (dropTableRecords)="onTableDropRecords($event)"
                  />
                } @else {
                  <textarea
                    class="w-full h-64 p-3 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    [value]="rawHeaders"
                    (input)="parseHeader($event)"
                    placeholder="Enter headers as JSON array..."
                  ></textarea>
                }
              </div>
              <div [hidden]="selectedTabIndex !== 2">
                <div class="flex justify-end mb-2">
                  <button
                    (click)="toggleEditorMode('body')"
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition-colors"
                  >
                    {{ typeEditorData.body === "table" ? "Raw" : "Table" }}
                  </button>
                </div>
                @if (typeEditorData.body === "table") {
                  <app-editable-table
                    [type]="'body'"
                    [list]="getList('body')"
                    [editingRow]="editingRow"
                    [editingCol]="editingCol"
                    [editingObj]="editingObj"
                    [infoRequest]="infoRequest"
                    [draggedItem]="draggedItem"
                    [isDragging]="isDragging"
                    [selectedTabIndex]="selectedTabIndex"
                    (editObj)="onTableEditObj($event)"
                    (selAll)="onTableSelAll($event)"
                    (onKeyDownEvent)="onTableKeyDown($event)"
                    (inputChangeEvent)="onTableInputChange($event)"
                    (deleteRec)="onTableDeleteRec($event)"
                    (onDragStartEvent)="onTableDragStart($event)"
                    (onDragEndEvent)="onTableDragEnd($event)"
                    (dropTableRecords)="onTableDropRecords($event)"
                  />
                } @else {
                  <textarea
                    class="w-full h-64 p-3 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    [value]="rawBody"
                    (input)="parseBody($event)"
                    placeholder="Enter body as JSON array..."
                  ></textarea>
                }
              </div>
              <div [hidden]="selectedTabIndex !== 3">
                <app-response-tab
                  [response]="response"
                  [currentResponseId]="currentResponseId"
                  [isResponseCollapsed]="isResponseCollapsed"
                  [infoRequest]="infoRequest"
                  (toggleResponseCollapsed)="toggleResponseCollapsed()"
                  (viewLatestResponse)="viewLatestResponse($event)"
                  (loadResponseFromHistory)="loadResponseFromHistory($event)"
                  (clearResponseHistory)="clearResponseHistory()"
                />
              </div>
            </div>
          } @else {
            <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
              <div class="text-center">
                <mat-icon fontIcon="web" class="!w-16 !h-16 !text-6xl mb-4 opacity-50" />
                <h3 class="text-lg font-medium mb-2">Select a Request</h3>
                <p>Choose a request from the sidebar to view and edit it</p>
              </div>
            </div>
          }
        </div>
      }
    </div>

    @if (windowInnerWidth <= 768 && isShowSidebar) {
      <div class="fixed inset-0 bg-black bg-opacity-50 z-10" (click)="isShowSidebar = false"></div>
    }
  </div>
</div>
